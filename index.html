<!DOCTYPE html>
<!-- saved from url=(0050)http://getbootstrap.com/examples/jumbotron-narrow/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Tree pattern search for genes tree">
    <meta name="author" content="">

    <title>TPS</title>

    <!-- Bootstrap core CSS -->
    <link href="./bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="./assets/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="./assets/style.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="./assets/ie-emulation-modes-warning.js"></script>
    <script src="./assets/jquery.min.js" charset="utf-8"></script>
    <script src="./bootstrap/dist/js/bootstrap.min.js" charset="utf-8"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  <style>.carbonad,
#content > #right > .dose > .dosesingle,
#content > #center > .dose > .dosesingle,
#carbonads-container
{display:none !important;}</style></head>

  <body>

    <div class="container">
      <div class="header clearfix">
        <nav>
          <ul class="nav nav-pills pull-right">
            <li role="presentation" class=""><a href="">Help</a></li>
            <li role="presentation" class=""><a href="">Contact</a></li>
          </ul>
        </nav>
        <h3 class="text-muted">Tree Pattern Search in <b>
          <span class="dropdown">
          <button class="btn-group-lg btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
            DATABASE
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
            <li><a href="#"><b>DATABASE</b></a></li>
          </ul>
        </span>
      </b> </h3>
      </div>
      <br>
      <div id="pattern" class="container">
        <div class="row">
          <div class="col-xs-9">
            <div id="svgLegend">

            </div>
            <div id="svgPattern">

            </div>
             <a href="#" class="btn btn-default disabled">Submit pattern</a>
          </div>

          <div class="col-xs-3" id="detail">
          <div id="info">
            <p>
              <div class="btn-group btn-group-justified">
                <a href="#" onClick="changeEvent()" class="btn btn-default" aria-hidden="true">Change event</a>
              </div>
            </p>
            <p>
              <div class="btn-group btn-group-justified">
                <a href="#" onClick="changeLinkEvent()" class="btn btn-default" aria-hidden="true">Constraint on path</a>
              </div>
            </p>
            <p>
              <div class="btn-group btn-group-justified">
                <a href="#" onClick="addChildren()" class="btn btn-default" aria-hidden="true">Add children</a>
              </div>
            </p>
            <p>
              <div class="btn-group btn-group-justified">
                <a href="#" onClick="removeChildren()" class="btn btn-default" aria-hidden="true">Remove children</a>
              </div>
            </p>
            <br>
            <p>
              <label for="inputdefault">Cardinality</label>
                <div class="form-group">
                        <div class="form-group row">
                            <div class="col-xs-6">
                                <label for="">min</label>
                                <input type="number" class="form-control" id="minCardinality" onchange="addCardinalityMin()" min="0">
                            </div>
                            <div class="col-xs-6">
                              <label for="">max</label>
                              <input type="number" class="form-control" id="maxCardinality" onchange="addCardinalityMax()" min="0">
                            </div>
                        </div>
                </div>
            </p>
            <br>
            <p>
              <div class="form-group">
                <label for="inputdefault">Taxon</label>
                <input id="taxon" class="form-control" id="inputdefault" type="text" placeholder="">
              </div>
            </p>

            <p>
              <div class="btn-group btn-group-justified">
                <a onclick="addAllowTaxonInFocus()" href="#" class="btn btn-default"> <span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span></a>
                <a onclick="addForbidTaxonInFocus()" href="#" class="btn btn-default"> <span class="glyphicon glyphicon-minus-sign" aria-hidden="true"></span></a>
              </div>
            </p>
            <p>
              <div class="list-group" id="listTaxon">
                <!-- <a href="#" class="list-group-item list-group-item-action list-group-item-success">Dapibus ac facilisis in  <span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a>
                <a href="#" class="list-group-item list-group-item-action list-group-item-danger">Vestibulum at eros <span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a> -->
              </div>
            </p>
          </div>
        </div>
        </div>
      </div>
      <br>
      <div class="container">
        <div class="row show-grid">
          <div class="col-xs-12">
            <div class="jumbotron">
              <p id="cypher">

              </p>
            </div>
          </div>
        </div>
      </div>
      <footer class="footer">
        <p><a href="https://lbbe.univ-lyon1.fr/">LBBE</a> | <a href="http://ancestrome.univ-lyon1.fr/">ANCESTROME</a></p>
      </footer>
    </div> <!-- /container -->





    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="./assets/ie10-viewport-bug-workaround.js"></script>
    <!-- Code application -->
    <script src="./node_modules/d3/build/d3.min.js" charset="utf-8"></script>

    <script type="text/javascript">
      function createCypherRequest() {
        //TODO
      }
    </script>

    <script type="text/javascript">
      //View//
      //Config
      var width = 750,
          height = 550,
          margin = {
            top : 0,
            bottom : 120,
            rigth : 0,
            left : 40
          },
          depth = 100;

          d3.symbolForbidden =  {
            draw: function(context, size) {
                var pi = Math.PI;
                var r = Math.sqrt(size / pi);
                context.arc(0, 0, r, 0, 2*pi);
                context.moveTo(Math.cos((pi)/4) * r, - Math.sin((pi)/4) * r);
                context.lineTo(Math.cos((5*pi)/4) * r, - Math.sin((5*pi)/4) * r);
                context.closePath();
                }
             }

           var symbolCircle = d3.symbol();
           symbolCircle.size(512);
           symbolCircle.type(d3.symbolCircle);

           var symbolForbidden = d3.symbol();
           symbolForbidden.size(512);
           symbolForbidden.type(d3.symbolForbidden);


        var events =
        [
            {
              id : 0,
              rights : "Allow",
              name : "Any",
              shape : symbolCircle,
              stroke : "black",
              fill : "white",
              textfill : "black",
              letter : ''
            }
        ,
            {
              id : 1,
              rights : "Must",
              name : "Duplication",
              shape : symbolCircle,
              stroke : "white",
              fill : "#005c99",
              textfill : "white",
              letter : 'D'
            }
        ,
            {
              id : 2,
              rights : "Forbidden",
              name : "Duplication",
              shape : symbolForbidden,
              stroke : "red",
              fill : "white",
              textfill : "black",
              letter : 'D'
            }
        ,
            {
              id : 3,
              rights : "Must",
              name : "Speciation",
              shape : symbolCircle,
              stroke : "white",
              fill : "#005c99",
              textfill : "white",
              letter : 'S'
            }
        ,
            {
              id : 4,
              rights : "Forbidden",
              name : "Speciation",
              shape : symbolForbidden,
              stroke : "red",
              fill : "white",
              textfill : "black",
              letter : 'S'
            }
        ]


      //Instance element
      var svg = d3.select("#svgPattern")
          .append("svg:svg")
          .attr("width", width)
          .attr("height", height)
          .attr("pointer-events", "all")
          .attr("cursor","pointer")
          .append("svg:g")
          .attr("transform","translate("+margin.left+","+margin.top+")");


      var legend =
      svg
      .append("g")
      .attr("transform","translate(0,15)");

      legend
      .append("line")                   // attach a line
        .style("stroke", "rgb(0, 92, 153)")           // colour the line
        .style("stroke-width", 8)          // adjust line width
        .attr("x1", 0)     // x position of the first end of the line
        .attr("y1", 0)     // y position of the first end of the line
        .attr("x2", 50)     // x position of the second end of the line
        .attr("y2", 0);

      var constraintLegend =
      svg
      .append("g")
      .attr("transform","translate(25,15)");

      constraintLegend
      .append("path")
      .attr("d","M12.766152972845846,0A12.766152972845846,12.766152972845846,0,1,1,-12.766152972845846,0A12.766152972845846,12.766152972845846,0,1,1,12.766152972845846,0")
      .style("stroke-width","2px")
      .style("stroke","white")
      .style("fill","rgb(0, 92, 153)");

      constraintLegend
      .append("text")
      .style("text-anchor","middle")
      .style("alignment-baseline","middle")
      .style("fill","white")
      .text("D");

      constraintLegend
      .append("g")
      .attr("transform","translate(40,4)")
      .append("text")
      .text("Only duplication on path");


      var constraintLegend2 =
      svg
      .append("g")
      .attr("transform","translate(25,40)");

      constraintLegend2
      .append("g")
      .attr("transform","translate(40,4)")
      .append("text")
      .text("No speciation on node");

      constraintLegend2
      .append("path")
      .attr("d","M12.766152972845846,0A12.766152972845846,12.766152972845846,0,1,1,-12.766152972845846,0A12.766152972845846,12.766152972845846,0,1,1,12.766152972845846,0M9.027033336764102,-9.0270333367641L-9.027033336764104,9.0270333367641Z")
      .style("stroke-width","2px")
      .style("stroke","red")
      .style("fill","white");

      constraintLegend2
      .append("text")
      .style("text-anchor","middle")
      .style("alignment-baseline","middle")
      .style("fill","black")
      .text("S");



      // var constraintLegend =
      // svg
      // .append("g")
      // .attr("transform","translate(25,50)");
      //
      //
      // svg
      // .append("path")
      // .attr("d","M12.766152972845846,0A12.766152972845846,12.766152972845846,0,1,1,-12.766152972845846,0A12.766152972845846,12.766152972845846,0,1,1,12.766152972845846,0")
      // .style("stroke-width","2px")
      // .style("stroke","white")
      // .style("fill","rgb(0, 92, 153)");


      var glinks =
         svg.append("svg:g");

      var gnodes =
          svg.append("svg:g");

      var gconstraints =
          svg.append("svg:g");


      //Data structures
      var firstNode = {
        nodeEvent : events[0],
        linkEvent : events[0],
        allowedTaxon : [],
        forbiddenTaxon : []
      };

      var treePatternRoot = {
        children : [firstNode]
      };

      var focusNode = firstNode;
      focusNode.focus = true;
      updateDetails();

      //Instance and configure layout computer
      var treeComputer =
        d3.cluster()
        .size([(height - margin.rigth -margin.left), (width - margin.top - margin.bottom)]);

      function computeAndDraw() {

        //Compute hierarchy and position
        var nodeRootHierarchy = d3.hierarchy(treePatternRoot);
        treeComputer(nodeRootHierarchy);


        var allLinks = nodeRootHierarchy.links();
        var allConstraints = allLinks.filter(function (d) {
          return d.target.data.linkEvent.rights !== "Allow";
        });

        var allNodes = nodeRootHierarchy.children[0].descendants();

        //Bind data with element (nodes and links)
        var nodes = gnodes.selectAll(".node")
          .data(allNodes);

        var textDetails = gnodes.selectAll(".textDetails")
          .data(allNodes);

        var textCardinalies = gnodes.selectAll(".textCardinalies")
          .data(allNodes);

        var links = glinks.selectAll(".link")
          .data(allLinks);

        var constraints = gconstraints.selectAll(".constraint")
          .data(allConstraints);


        //LINKS
        //EXIT
        links.exit().remove();

        //ENTER + UPDATE
        links
          .enter()
          .append("path")
          .classed("link",true)
          .style("fill","none")
          .style("stroke-width","8px")
          .merge(links)
          .style("stroke",function (d) {
            var stroke = d.target.data.linkEvent.stroke;
            var fill = d.target.data.linkEvent.fill;
            if(stroke != "white"){
              return stroke;
            }
            else if(fill != "white"){
              return fill;
            }else{
              return "black";
            }
          })
          .attr("d",function (d) {
            var path = d3.path();
            path.moveTo(d.source.y,d.source.x);
            path.quadraticCurveTo(d.source.y , d.target.x, d.target.y, d.target.x)
            return path.toString();
          });

        //Draw nodes
        //EXIT
        nodes.exit().remove();

        //ENTER
        var newNodesGroup =
        nodes
          .enter()
          .append("g")
          .classed("node",true);

        newNodesGroup
          .append("path")
          .attr("class","shape");

        newNodesGroup
          .append("text")
          .attr("class","textNode")
          .style("text-anchor","middle")
          .style("alignment-baseline","middle");

        //ENTER + UPDATE
        var nodesGroup =
        newNodesGroup
          .merge(nodes)
          .attr("transform",function(d) {
            var x = d.x;
            var y = d.y;
            return "translate("+y+","+x+")";
          })
          .on("click",function (d) {
            focusOnNode(d);
          });

        nodesGroup
          .select(".shape")
          .attr("d",function (d) {
            if(d.data.children){
              return d.data.nodeEvent.shape();
            }else{
              return symbolCircle();
            }

          })
          .style("stroke-width", function (d) {
              if(d.data.focus){
                return "5px"
              }else{
                return "2px"
              }
          })
          .style("stroke",function (d) {
            if(d.data.children){
              return d.data.nodeEvent.stroke;
            }else{
              return "black";
            }

          })
          .style("fill",function (d) {
            if(d.data.children){
              return d.data.nodeEvent.fill;
            }
            else{
              return "white";
            }
          });

        nodesGroup
          .select(".textNode")
          .style("fill",function (d) {
            if(d.data.children){
              return d.data.nodeEvent.textfill;
            }
            else{
              return "black";
            }
          })
          .text(function (d) {
            if(d.data.children){
              return d.data.nodeEvent.letter;
            }
            else{
              return "L";
            }
          });


        //EXIT
        textDetails.exit().remove();

        //ENTER
        var newDetailsTextGroup =
        textDetails
          .enter()
          .append("text")
          .classed("textDetails",true)
          .style("text-anchor","end");


        //ENTER + UPDATE
        var allDetailsTextGroup =
        newDetailsTextGroup
        .merge(textDetails)
        .attr("transform",function(d) {
          var x = d.x + 20;
          var y = d.y ;
          return "translate("+y+","+x+")";
        });

        allDetailsTextGroup.each(function (d) {

          var allowedTaxons = d3.select(this)
          .selectAll(".allowedTaxon")
          .data(d.data.allowedTaxon);

          allowedTaxons.exit().remove();

          var forbiddenTaxons = d3.select(this)
          .selectAll(".forbiddenTaxon")
          .data(d.data.forbiddenTaxon);

          forbiddenTaxons.exit().remove();

          var enterAllowedTaxons=
          allowedTaxons
          .enter()
          .append("tspan")
          .attr("fill","green")
          .attr("class","allowedTaxon");

          enterAllowedTaxons
          .merge(allowedTaxons)
          .attr("dy",15)
          .attr("x",0)
          .text(function (e) {
            return e;
          });

          var enterForbiddenTaxons=
          forbiddenTaxons
          .enter()
          .append("tspan")
          .attr("class","forbiddenTaxon")
          .attr("fill","red")
          .style("text-decoration","line-through")

          enterForbiddenTaxons
          .merge(forbiddenTaxons)
          .attr("dy",15)
          .attr("x",0)
          .text(function (e) {
            return e;
          });

        });


        //EXIT
        textCardinalies.exit().remove();

        //ENTER
        var newTextCardinalies =
        textCardinalies
          .enter()
          .append("text")
          .classed("textCardinalies",true)
          .style("text-anchor","end");


        //ENTER + UPDATE
        var allTextCardinalies =
        newTextCardinalies
        .merge(textCardinalies)
        .attr("transform",function(d) {
          var x = d.x - 20;
          var y = d.y - 5;
          return "translate("+y+","+x+")";
        })
        .text(function (d) {
          var text = "";
          var minC = d.data.minCardinality;
          var maxC = d.data.maxCardinality;
          if(minC){
            text += minC + " ≤ "
          }
          if(minC || maxC){
            text += "n"
          }
          if(maxC){
            text += " ≤ " + maxC
          }
          return text;
        });





        //EXIT
        constraints.exit().remove();

        //ENTER
        var newConstraintsGroup =
          constraints
          .enter()
          .append("g")
          .classed("constraint",true);

        newConstraintsGroup
          .append("path")
          .attr("class","pathCstGrp")
          .style("stroke-width", "2px");

        newConstraintsGroup
          .append("text")
          .attr("class","textCstGrp")
          .style("text-anchor","middle")
          .style("alignment-baseline","middle");


        //ENTER + UPDATE
        var constraintsGroup =
          newConstraintsGroup
          .merge(constraints)
          .attr("transform",function(d) {
            var x = d.target.x;
            var y =(d.source.y) + (((d.target.y) - (d.source.y)) / 2 )
            return "translate("+y+","+x+")";
          });

        constraintsGroup.select(".pathCstGrp")
          .style("stroke",function (d) {
            return d.target.data.linkEvent.stroke;
          })
          .style("fill",function (d) {
            return d.target.data.linkEvent.fill;
          })
          .attr("d",function (d) {
            return d.target.data.linkEvent.shape();
          });

        constraintsGroup.select(".textCstGrp")
          .style("fill",function (d) {
            return d.target.data.linkEvent.textfill;
          })
          .text(function (d) {
            return d.target.data.linkEvent.letter;
          });

        updateCypher();
      }
      computeAndDraw();

      //Add child to treeNode
      function addChildren () {
        if(!focusNode.children){
          focusNode.children = [
            {
              nodeEvent : events[0],
              linkEvent : events[0],
              allowedTaxon : [],
              forbiddenTaxon : []
            },
            {
              nodeEvent : events[0],
              linkEvent : events[0],
              allowedTaxon : [],
              forbiddenTaxon : []
            }
          ];
        }
        computeAndDraw();
        updateDetails();
      }

      //Add child to treeNode
      function removeChildren () {
        if(focusNode.children){
          focusNode.nodeEvent = events[0];
          focusNode.children = undefined;
        }
        computeAndDraw();
        updateDetails();
      }

      //Change node event
      function changeEvent () {
        if(focusNode.children){
          var nodeEvent = focusNode.nodeEvent;
          newIdEvent = (nodeEvent.id + 1) %  events.length;
          focusNode.nodeEvent = events[newIdEvent];
          computeAndDraw();
        }
      }

      //Change node forbidden Event
      function changeLinkEvent () {
        var linkEvent = focusNode.linkEvent;
        newIdEvent = (linkEvent.id + 1) %  events.length;
        focusNode.linkEvent = events[newIdEvent];
        computeAndDraw();
      }

      //Add constraint in node
      function addConstraintInNode (forbidden) {

        var taxon = $('#taxon').val();
        if(taxon){
          if(forbidden){
            focusNode.forbiddenTaxon.push(taxon);
          }else {
            focusNode.allowedTaxon.push(taxon);
          }
          updateDetails();
        }
        var taxon = $('#taxon').val("");
        computeAndDraw();
      }

      function updateDetails () {
        var listTaxonDom = $('#listTaxon');
        var minCardinality = $('#minCardinality');
        var maxCardinality = $('#maxCardinality');

        listTaxonDom.empty();
        minCardinality.val("");
        maxCardinality.val("");

        if(focusNode.children){
          minCardinality.prop('disabled', false);
          maxCardinality.prop('disabled', false);
        }else{
          focusNode.minCardinality = undefined;
          focusNode.maxCardinality = undefined;
          minCardinality.prop('disabled', true);
          maxCardinality.prop('disabled', true);
        }

        minCardinality.val(focusNode.minCardinality);
        maxCardinality.val(focusNode.maxCardinality);

        focusNode.allowedTaxon.forEach(function (e,i) {
          listTaxonDom.append('<button onclick=removeAllowedTaxon('+i+') class="list-group-item list-group-item-action list-group-item-success">'+e+'<span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>');
        });

        focusNode.forbiddenTaxon.forEach(function (e,i) {
          listTaxonDom.append('<button onclick=removeForbiddenTaxon('+i+') class="list-group-item list-group-item-action list-group-item-danger">'+e+'<span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button >');
        });

      }

      function focusOnNode (treeNode){
        focusNode.focus = false;
        focusNode = treeNode.data;
        focusNode.focus = true;
        updateDetails();
        computeAndDraw();
      }

      function addAllowTaxonInFocus() {
        addConstraintInNode(false);
      }

      function addForbidTaxonInFocus() {
        addConstraintInNode(true);
      }

      function removeAllowedTaxon(i) {
        focusNode.allowedTaxon.splice(i, 1);
        updateDetails();
        computeAndDraw();
      }

      function removeForbiddenTaxon(i) {
        focusNode.forbiddenTaxon.splice(i, 1);
        updateDetails();
        computeAndDraw();
      }

      function addCardinalityMin() {
        var val = $('#minCardinality').val();
        val = Math.abs(parseInt(val));
        if(focusNode.children){
          focusNode.minCardinality = val;
          if(focusNode.minCardinality == 0){
            focusNode.minCardinality = undefined
          }
        }
        computeAndDraw();
      }

      function addCardinalityMax() {
        var val = $('#maxCardinality').val();
        val = Math.abs(parseInt(val));
        if(focusNode.children){
          focusNode.maxCardinality = val;
          if(focusNode.maxCardinality == 0){
            focusNode.maxCardinality = undefined
          }
        }
        computeAndDraw();
      }

      function updateCypher() {
        $('#cypher').html(JSON.stringify(firstNode,null,1));
      }

    </script>

  </body>
</html>
